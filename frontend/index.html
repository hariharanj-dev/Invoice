<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invoice App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDnt-HRZ96l8L2NSVF5x2dyrdMKaouBo4E",
      authDomain: "invoice-8ff3d.firebaseapp.com",
      projectId: "invoice-8ff3d",
      storageBucket: "invoice-8ff3d.firebasestorage.app",
      messagingSenderId: "429434497748",
      appId: "1:429434497748:web:55a293d90ec66c1c5ce941",
      measurementId: "G-02EPHNT9TN"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
  </script>

  <!-- ✅ Fade In Animation -->
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.6s ease-out;
    }
  </style>
</head>
<body class="bg-gray-100">

<!-- Navbar -->
<nav class="bg-black text-white px-6 py-3 flex justify-between items-center">
  <h1 id="navbarTitle" class="text-xl font-bold">Invoice App</h1>
  <button id="menuBtn" class="sm:hidden text-white focus:outline-none">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M4 6h16M4 12h16M4 18h16" />
    </svg>
  </button>
  <div id="menu" class="hidden sm:flex space-x-6 items-center">
    <a href="index.html" class="nav-link px-3 py-1 rounded">Home</a>
    <a href="history.html" class="nav-link px-3 py-1 rounded">Invoices</a>
    <a href="edit-company.html" class="nav-link px-3 py-1 rounded">Company</a>
    
    <span id="userEmail" class="text-yellow-300 font-medium hidden"></span>
    
    <button id="loginBtn" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Login</button>
    <button id="logoutBtn" class="bg-red-500 text-white px-3 py-1 rounded hidden">Logout</button>
  </div>
</nav>

<div id="mobileMenu" class="hidden bg-black text-white px-6 py-2 sm:hidden">
  <a href="index.html" class="nav-link block py-2 rounded">Home</a>
  <a href="history.html" class="nav-link block py-2 rounded">Invoices</a>
  <a href="edit-company.html" class="nav-link block py-2 rounded">Company</a>
  <span id="userEmail" class="text-yellow-300 font-medium hidden"></span>
      <button id="loginBtn" class="bg-white text-blue-600 px-3 py-1 rounded hover:bg-gray-100">Login</button>
    <button id="logoutBtn" class="bg-red-500 text-white px-3 py-1 rounded hidden">Logout</button>
</div>

<!-- ✅ Animate Invoice Section -->
<div class="max-w-4xl mx-auto bg-white shadow p-6 rounded-lg mt-6 animate-fadeIn">
  <h2 class="text-2xl font-bold mb-6 text-center sm:text-left">Invoice Management</h2>

  <form id="invoiceForm" class="space-y-4 mb-8">
    <div>
      <label class="block font-medium">Customer Name</label>
      <input type="text" id="customerName" class="border w-full p-2 rounded" required />
    </div>
    <div class="grid sm:grid-cols-2 gap-4">
      <div>
        <label class="block font-medium">Customer Email</label>
        <input type="email" id="customerEmail" class="border w-full p-2 rounded" />
      </div>
      <div>
        <label class="block font-medium">Customer Phone</label>
        <input type="text" id="customerPhone" class="border w-full p-2 rounded" />
      </div>
    </div>

    <div>
      <label class="block font-medium">Items</label>
      <div id="itemsContainer" class="space-y-2"></div>
      <button type="button" id="addItem" class="mt-2 px-3 py-2 bg-blue-500 text-white rounded w-full sm:w-auto">
        + Add Item
      </button>
    </div>

    <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white rounded">Save Invoice</button>
  </form>

  <h2 id="invoices" class="text-xl font-semibold mb-2">Invoices</h2>
  <div class="overflow-x-auto">
    <table class="w-full border text-sm sm:text-base">
      <thead>
        <tr class="bg-gray-200">
          <th class="p-2">ID</th>
          <th class="p-2">Customer</th>
          <th class="p-2">Total</th>
          <th class="p-2">Date</th>
          <th class="p-2">Actions</th>
        </tr>
      </thead>
      <tbody id="invoiceTableBody"></tbody>
    </table>
  </div>
</div>

<script>
  const API_BASE = "http://localhost:5000";
  const form = document.getElementById("invoiceForm");
  const tbody = document.getElementById("invoiceTableBody");
  const itemsContainer = document.getElementById("itemsContainer");
  const addItemBtn = document.getElementById("addItem");

  const menuBtn = document.getElementById("menuBtn");
  const mobileMenu = document.getElementById("mobileMenu");
  menuBtn.addEventListener("click", () => {
    mobileMenu.classList.toggle("hidden");
  });

  // Temporary array to store session-only invoices
  let sessionInvoices = [];

  // Add first item field
  addItemField();
  addItemBtn.addEventListener("click", () => addItemField());

  function addItemField() {
    const div = document.createElement("div");
    div.classList.add("flex", "flex-col", "sm:flex-row", "sm:space-x-2", "gap-2");
    div.innerHTML = `
      <input type="text" placeholder="Description" class="border p-2 rounded flex-1 item-desc" required/>
      <input type="number" placeholder="Qty" class="border p-2 rounded w-full sm:w-20 item-qty" required/>
      <input type="number" placeholder="Price" class="border p-2 rounded w-full sm:w-24 item-price" required/>
    `;
    itemsContainer.appendChild(div);
  }

  // Handle form submit
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) {
      alert("You must be logged in to save invoices");
      return;
    }

    const items = Array.from(document.querySelectorAll("#itemsContainer div")).map(div => ({
      description: div.querySelector(".item-desc").value,
      quantity: Number(div.querySelector(".item-qty").value),
      price: Number(div.querySelector(".item-price").value),
    }));

    const invoice = {
      userEmail: user.email,
      customerName: document.getElementById("customerName").value,
      customerEmail: document.getElementById("customerEmail").value,
      customerPhone: document.getElementById("customerPhone").value,
      items,
    };

    const res = await fetch(`${API_BASE}/api/invoices`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(invoice),
    });
    const data = await res.json();
    if (data.success) {
      alert("Invoice saved!");
      form.reset();
      itemsContainer.innerHTML = "";
      addItemField();

      // ✅ Add to session invoices and render
      sessionInvoices.push(data.data); // backend must return the saved invoice
      renderSessionInvoices();
    } else {
      alert("Error saving invoice");
    }
  });

  // Render invoices for this session only
  function renderSessionInvoices() {
    tbody.innerHTML = "";
    if (sessionInvoices.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5" class="p-2 text-center">No invoices yet</td></tr>`;
      return;
    }

    sessionInvoices.forEach(inv => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="p-2">${inv._id}</td>
        <td class="p-2">${inv.customerName}</td>
        <td class="p-2">₹${inv.total}</td>
        <td class="p-2">${new Date(inv.date).toLocaleDateString()}</td>
        <td class="p-2 flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0">
          <a href="${API_BASE}/api/invoices/${inv._id}/pdf" 
             class="px-2 py-1 bg-blue-600 text-white rounded text-center"
             target="_blank">Download</a>
          <a href="${API_BASE}/api/invoices/${inv._id}/print" 
             class="px-2 py-1 bg-green-600 text-white rounded text-center"
             target="_blank">Print</a>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Firebase Login/Logout
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const userEmailSpan = document.getElementById("userEmail");

  loginBtn.addEventListener("click", () => {
    window.location.href = "login.html";
  });

  logoutBtn.addEventListener("click", async () => {
    await auth.signOut();
    alert("Logged out!");
    window.location.href = "login.html";
  });

  const navbarTitle = document.getElementById("navbarTitle");

  auth.onAuthStateChanged(user => {
    if (user) {
      loginBtn.classList.add("hidden");
      logoutBtn.classList.remove("hidden");
      userEmailSpan.textContent = user.email;
      userEmailSpan.classList.remove("hidden");

      // ✅ Change navbar title to welcome the user
      const name = user.email.split("@")[0]; // extract name from email
      navbarTitle.textContent = `Invoice Welcome's ${name}!`;

    } else {
      loginBtn.classList.remove("hidden");
      logoutBtn.classList.add("hidden");
      userEmailSpan.textContent = "";
      userEmailSpan.classList.add("hidden");

      // ✅ Revert navbar title when logged out
      navbarTitle.textContent = "Invoice App";
      
      // Clear session invoices
      sessionInvoices = [];
      renderSessionInvoices();
    }
  });

  // Highlight Active Nav Link
  const currentPage = window.location.pathname.split("/").pop();
  document.querySelectorAll(".nav-link").forEach(link => {
    if (link.getAttribute("href") === currentPage) {
      link.classList.add("bg-blue-500", "text-white");
    } else {
      link.classList.add("text-white", "hover:bg-blue-500");
    }
  });
</script>
</body>
</html>
